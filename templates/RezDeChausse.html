<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rez de chaussée</title>
    
    <style>
      header {
        display: flex;
        flex-direction: column; /* Aligne verticalement */
        align-items: left; /* Centre horizontalement */
        text-align: center;
        margin: 20px;
      }

      header svg {
        margin: 20px 0; /* Espace autour du dessin */
      }

      header a {
        text-decoration: none;
        color: blue;
        margin-top: 10px;
      }

      body {
        font-family: sans-serif;
      }
      .radiateur {
        border: 1px solid #ccc;
        padding: 10px;
        margin: 10px;
        cursor: pointer;
        text-align: center;
        display: inline-block;
      }

      .piece {
        font-weight: bold;
        text-align: center;
        fill: black;
        cursor: pointer;
        font-size: 12px;
      }

      /* Fenêtre modale*/
      .modal {
        display: none;
        position: fixed;
        z-index: 10;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background: #fff;
        margin: 10% auto;
        padding: 20px;
        width: 300px;
        border-radius: 8px;
        text-align: center;
      }

      .modal-content-config {
        background: #fff;
        margin: 10% auto;
        padding: 1px;
        width: 650px;
        border-radius: 8px;
        text-align: center;
      }
      
      /* Empiler les boutons verticalement */
      .button-column {
        margin-top: 40px;
        display: flex;
        flex-direction: column; /* empile verticalement */
        gap: 10px;              /* espace entre les boutons */
      } 
      
      /* Empiler les boutons horizontalement */
      .button-column {
        margin-top: 40px;
        display: flex;
        flex-direction: column; /* empile horizontalement */
        gap: 10px;              /* espace entre les boutons */
      } 

      /* Empiler les items horizontalement */
      .items-row{
        text-align: left;
        display: flex;
        flex-direction: row; /* empile horizontalement */
        gap: 10px;              /* espace entre les items*/
      } 
      
      /* Empiler les items verticalement */
      .items-column{
        text-align: left;
        display: flex;
        flex-direction: column; /* empile verticalement */
        gap: 20px;              /* espace entre les items*/
      } 
      
      /* Empiler les items times verticalement */
      .times-column{
        text-align: left;
        display: flex;
        flex-direction: column; /* empile verticalement */
        gap: 10px;              /* espace entre les items*/
      } 

      #mode-combo, #jour-combo {
        width: 100px;
        padding: 8px;
        margin-top: 8px;
      }

      /* sélection par ID */
      #h-combo, #m-combo {
        width: 60px;
      } 

      .close {
        color: red;
        float: right;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Rez de chaussée</h1>

      <!-- plan du rez de chaussee -->
      <svg width="600" height="600">
        <!-- murs extérieurs -->
        <line
          x1="50"
          y1="550"
          x2="550"
          y2="550"
          stroke="black"
          stroke-width="4"
        />
        <!-- devant -->
        <line
          x1="50"
          y1="200"
          x2="50"
          y2="550"
          stroke="black"
          stroke-width="4"
        />
        <!-- gauche -->
        <line
          x1="550"
          y1="50"
          x2="550"
          y2="550"
          stroke="black"
          stroke-width="4"
        />
        <!-- droit -->
        <line
          x1="50"
          y1="200"
          x2="275"
          y2="200"
          stroke="black"
          stroke-width="4"
        />
        <!-- jardin salle -->
        <line
          x1="275"
          y1="50"
          x2="275"
          y2="200"
          stroke="black"
          stroke-width="4"
        />
        <!-- renfoncement salon -->
        <line
          x1="275"
          y1="50"
          x2="550"
          y2="50"
          stroke="black"
          stroke-width="4"
        />
        <!-- jardin chambre -->

        <!-- cloisons garage -->
        <line
          x1="325"
          y1="375"
          x2="325"
          y2="550"
          stroke="black"
          stroke-width="2"
        />
        <!-- vertical -->
        <line
          x1="325"
          y1="375"
          x2="550"
          y2="375"
          stroke="black"
          stroke-width="2"
        />
        <!-- horizontal -->
        <!-- cloisons salle de bain / chambre-->
        <line
          x1="425"
          y1="300"
          x2="425"
          y2="375"
          stroke="black"
          stroke-width="2"
        />
        <!-- vertical -->
        <line
          x1="375"
          y1="300"
          x2="550"
          y2="300"
          stroke="black"
          stroke-width="2"
        />
        <!-- horizontal -->
        <line
          x1="375"
          y1="50"
          x2="375"
          y2="300"
          stroke="black"
          stroke-width="2"
        />
        <!-- vertical -->
        <!-- cloisons cuisine -->
        <line
          x1="250"
          y1="400"
          x2="250"
          y2="550"
          stroke="black"
          stroke-width="2"
        />
        <!-- vertical -->
        <line
          x1="50"
          y1="400"
          x2="250"
          y2="400"
          stroke="black"
          stroke-width="2"
        />
        <!-- horizontal -->

        <!-- Noms des pièces -->
        {% for p in pieces %}
        <text 
          class="piece"
          id="{{ p.id }}"
          x="{{ p.x }}" 
          y="{{ p.y }}">{{ p.nom }}</text> 

        {% endfor %}

        <!-- radiateurs -->
        {% for r in radiateurs %}
        <rect
          class="radiateur"
          id="{{ r.id }}"
          nom="{{ r.nom }}"
          data-nom="{{ r.nom }}"
          data-state="{{ r.state }}"
          data-nom_state =""
          data-groupe="{{ r.groupe}}"
          data-forceheure="{{r.timeforce.heure}}"
          data-forceminute="{{r.timeforce.minute}}"
          data-schedule="{{ r.schedule }}"
          x="{{ r.x }}"
          y="{{ r.y }}"
          width="{{ r.width }}"
          height="{{ r.height }}"
          rx="3"
        />
        {% endfor %}
      </svg>


      <!-- Fenêtre modale main -->
      <div id="MainModal" class="modal">
        <div class="modal-content">
          <span class="close" id="closeModal_Main">&times;</span>
          <h2 id="MainNom"></h2>
          <p>Etat actuel : <span id="MainState"></span></p>
          <div class="button-column">
            <button id="modify_req">Modifier une fois</button>
            <button id="config_req">Configurer</button>
          </div>
        </div>
      </div>


      <!-- Fenêtre modale Modifier -->
      <div id="ModifModal" class="modal">
        <div class="modal-content">
          <span class="close" id="closeModal_Modif">&times;</span>
          <h2 id="ModifNom"></h2>
          <p>Etat actuel : <span id="ModifState"></span></p>
          <div class="items-column">
            <div class="items-row">
              <label>Nouveau mode :</label>
              <!-- Combobox pour les états-->
              <select id="mode-Combo">
                <!-- Options ajoutées dynamiquement en JS -->
              </select>
            </div>
            <div class="times-column">
              <label for="duree-select">Selection de la durée :</label>
              <div class="items-row">
                <label>Heures :</label>
                <select id="h-combo">
                  <!-- Options ajoutées dynamiquement en JS -->
                </select>

                <label>Minutes :</label>
                <select id="m-combo">
                  <!-- Options ajoutées dynamiquement en JS -->
                </select>
              </div>
            </div>
          </div>

          <div class="button-column">
            <button id="Apply_modif_req">Modifier</button>
          </div>
        </div>
      </div>


      <!-- Fenêtre modale Configurer -->
      <div id="ConfigModal" class="modal">
        <div class="modal-content-config">
          <span class="close" id="closeModal_Config">&times;</span>
          <h2 id="ConfigNom"></h2>
          <div class="items-column">
            <div class="items-row">
              <label>Jour :</label>
              <!-- Combobox pour les états-->
              <select id="jour-Combo">
                <!-- Options ajoutées dynamiquement en JS -->
              </select>
            </div>
            <label>Graphe mode / heure :</label>
            <div class="zoneCanvas" style="position: relative; width:626px; height:300px;">
              <canvas id="etatGraph" width="626" height="300" style="position: rabsolute; left:0; top:0;"></canvas>
              <canvas id="posMouse" width="626" height="300" style="position: absolute; left:0; top:0; pointer-events: none;"></canvas>
            </div>
          </div>

          <div class="button-row">
            <button id="Plus_config_req">+</button>
            <button id="Minus_config_req">-</button>
            <button id="Apply_config_req">Apply</button>
          </div>
        </div>
      </div>


      <!-- Fenêtre modale delete point -->
      <div id="DelPointModal" class="modal">
        <div class="modal-content">
          <span class="close" id="closeModal_DelPoint">&times;</span>
          <h2 id="DelPointNom"></h2>
          <h2 id="DelPointJour"></h2>
          <div class="items-column">
            <div class="items-row">
              <label>Delete:</label>
              <!-- Combobox pour les points -->
              <select id="DelPointCombo">
                <!-- Options ajoutées dynamiquement en JS -->
              </select>
            </div>
          </div>

          <button id="DelPoint_config_req">Apply</button>
        </div>
      </div>


      <!-- Fenêtre modale Add point -->
      <div id="AddPointModal" class="modal">
        <div class="modal-content">
          <span class="close" id="closeModal_AddPoint">&times;</span>
          <h2 id="AddPointNom"></h2>
          <h2 id="AddPointJour"></h2>
          <div class="items-column">
            <div class="items-row">
              <label>Nouveau mode :</label>
              <!-- Combobox pour les états-->
              <select id="AddModeCombo">
                <!-- Options ajoutées dynamiquement en JS -->
              </select>
            </div>
            <div class="times-column">
              <label for="AddTimeSelect">Heure changement :</label>
              <div class="items-row">
                <label>Heures :</label>
                <select id="AddHeureCombo">
                  <!-- Options ajoutées dynamiquement en JS -->
                </select>

                <label>Minutes :</label>
                <select id="AddMinuteCombo">
                  <!-- Options ajoutées dynamiquement en JS -->
                </select>
              </div>
            </div>
          </div>

          <div class="button-column">
            <button id="AddPoint_config_req">Apply</button>
          </div>
        </div>
      </div>

      <!-- retour page précédente -->
      <a href="/">Home</a>

      <script>
        const ModeCombo = document.getElementById("mode-Combo");
        const HCombo = document.getElementById("h-combo");
        const MCombo = document.getElementById("m-combo");
        const JourCombo = document.getElementById("jour-Combo");
        const apply_config_req = document.getElementById("Apply_config_req");
        const plus_config_req = document.getElementById("Plus_config_req");
        const minus_config_req = document.getElementById("Minus_config_req");
        const DelPointModal = document.getElementById("DelPointModal");
        const DelPointNom = document.getElementById("DelPointNom");
        const DelPointJour = document.getElementById("DelPointJour");
        const DelPointCombo = document.getElementById("DelPointCombo");
        const DelPoint_config_req = document.getElementById("DelPoint_config_req");

        let forceheure = 0;
        let forceminute = 0;
        let itempointer = null;
        let IsGroupe = false;
        let Schedule = [];
        let CurJour = 0;
        let LockHeure= 0;
        let LockMinute = 0;
        let LockMode = 1;

        // Dictionnaire de correspondance valeur → couleur
        const couleurs = {
          0: "black",
          1: "red",
          2: "yellow",
          3: "blue"
        };

        // Dictionnaire de correspondance valeur → nom de l'état
        const nom_state = {
          0: "Off",
          1: "Confort",
          2: "Eco",
          3: "Hors gel"
        };

        //liste des jours de la semaine
        const JoursSemaine = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"];

        function ChangeRadiateurColor() {
          console.log("Changing radiateur colors...");
          // Boucle sur les rectangles SVG
          const items = document.querySelectorAll(".radiateur");
          console.log(`Found ${items.length} radiateurs.`);
          items.forEach((item) => {
            console.log(`radiateur ${item.id}: etat: ${item.dataset.state}`);
            const couleur = couleurs[ item.dataset.state] || "gray"; // défaut si valeur inconnue
            item.dataset.nom_state = nom_state[ item.dataset.state] || "Inconnu";
            item.setAttribute("fill", couleur);
          });
        };

        document.querySelectorAll(".radiateur").forEach((el) => {
          el.addEventListener("click", () => {
            MainNom.textContent = el.dataset.nom;
            MainState.textContent = el.dataset.nom_state;
            forceheure = el.dataset.forceheure;
            forceminute = el.dataset.forceminute;
            itempointer = el;
            IsGroupe = false;
            let ScheduleString = el.dataset.schedule;
            ScheduleString = ScheduleString.replace(/'/g, '"');   // conversion rapide vers JSON valide
            Schedule = JSON.parse(ScheduleString);
            for( let i = 0; i < Schedule.length; i++ ){
              console.log(`schedule ${i}: heure: ${Schedule[i].heure} mode: ${Schedule[i].mode}`);
            }
            MainModal.style.display = "block";
          });
        });

        document.querySelectorAll(".piece").forEach((el) => {
          el.addEventListener("click", () => {
            console.log(`piece ${el.textContent}`);
            const items = Array.from(document.querySelectorAll(".radiateur"));
            if(items.some((item) => {
              console.log(`radiateur ${item.id}: groupe: ${item.dataset.groupe}`);
              if(item.dataset.groupe === el.textContent.trim()){
                MainState.textContent = item.dataset.nom_state;
                forceheure = item.dataset.forceheure;
                forceminute = item.dataset.forceminute;
                Schedule = item.dataset.schedule;
                return true; // arrêter la boucle some
              }
            }) === false){
              alert("Cette pièce n'est pas un groupe.");
            }
            else{
              MainNom.textContent = el.textContent;
              itempointer = el;
              IsGroupe = true;
              MainModal.style.display = "block";
             }
          });
        });

        document.getElementById("closeModal_Main").onclick = () => {
          MainModal.style.display = "none";
        };
        
        document.getElementById("closeModal_Modif").onclick = () => {
          ModifModal.style.display = "none";
        };
        
        document.getElementById("closeModal_Config").onclick = () => {
          ConfigModal.style.display = "none";
        };

        window.onclick = (event) => {
          if (event.target === MainModal) MainModal.style.display = "none";
          if (event.target === ModifModal) ModifModal.style.display = "none";
          if (event.target === ConfigModal) ConfigModal.style.display = "none";
        };

        modify_req.onclick = () => {
          MainModal.style.display = "none";
          ModifNom.textContent = MainNom.textContent;
          ModifState.textContent = MainState.textContent;

          ModeCombo.innerHTML = "";
          const ModeOptions = ["Off", "Confort", "Eco", "Hors gel"];
          ModeOptions.forEach(opt => {
            const optionElement = document.createElement("option");
            optionElement.value = ModeOptions.indexOf(opt);
            optionElement.textContent = opt;
            ModeCombo.appendChild(optionElement);
          });
          // Définir la valeur initiale
          ModeCombo.value = MainState.textContent === "Off" ? 0 :
                           MainState.textContent === "Confort" ? 1 :
                           MainState.textContent === "Eco" ? 2 :
                           MainState.textContent === "Hors gel" ? 3 : 0; 

          // Remplir les combobox heures
          HCombo.innerHTML = "";
          const ForceHeureOptions = ["00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", 
            "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23"];
          ForceHeureOptions.forEach(opt => {
            const optionElement = document.createElement("option");
            optionElement.value = ForceHeureOptions.indexOf(opt);
            optionElement.textContent = opt;
            HCombo.appendChild(optionElement);
          });
          //definir la valeur initiale
          HCombo.value = forceheure;

          // Remplir les combobox minutes
          MCombo.innerHTML = "";
          const ForceMinuteOptions = ["00", "05", "10", "15", "20", "25", "30", "35", "40", "45", "50", "55"];
          ForceMinuteOptions.forEach(opt => {
            const optionElement = document.createElement("option");
            optionElement.value = ForceMinuteOptions.indexOf(opt) * 5;
            optionElement.textContent = opt;
            MCombo.appendChild(optionElement);
          });
          //definir la valeur initiale
          MCombo.value = (forceminute /5) * 5;

          ModifModal.style.display = "block";
        };

        //Définition des graphes
        const Canvas = document.querySelector("#etatGraph");
        const ctx = Canvas.getContext("2d");
        const PosMouse = document.querySelector("#posMouse");
        const ctxPosMouse = PosMouse.getContext("2d");

        function LoadGraphModeTime( NumJour) {
          //value -> nom du jour
          let Jour = JoursSemaine[NumJour];
          //trier suivant les heures croissantes
          Schedule[ Jour].sort((a, b) => (((a.heure * 60) + a.minute) - ((b.heure * 60) + b.minute)));
          // properties
          let width = Canvas.width;
          let height = Canvas.height;
          console.log(`canvas, width= ${width}, height= ${height}`);
          // Effacer le canvas
          ctx.clearRect(0, 0, width, height); 
          ctxPosMouse.clearRect(0, 0, width, height); 
          //dessiner le cadre
          ctx.strokeStyle = "black";
          ctx.strokeRect(1, 1, width - 1, height - 1);
          // Dessiner l'axe horizontal'
          ctx.beginPath();
          ctx.moveTo(40, height - 50);
          ctx.lineTo(width - 10, height - 50);
          ctx.strokeStyle = "black";
          ctx.stroke();
          //dessiner les creneaux d'heure
          for (let h = 0; h <= 24; h += 1) {
            let x = 40 + (h * 24);
            ctx.beginPath();
            ctx.moveTo(x, height - 52);
            ctx.lineTo(x, height - 45);
            ctx.stroke();
            // Ajouter les étiquettes horaires
            ctx.fillStyle = "black";
            ctx.font = "10px Arial";
            ctx.fillText(h.toString().padStart(2, '0'), x - 5, height - 30);
          }
          //ecrire les modes
          for (let m = 0; m <= 3; m += 1) {
            let y = height - 60 - (m * 50);
            ctx.fillStyle = "black";
            ctx.font = "10px Arial";
            ctx.fillText(nom_state[m],2, y + 3);
          }
          // Dessiner les points et les lignes
          ctx.beginPath();
          //init
          let CurrentMode = 1;
          let CurrentHeure = 0;
          let CurrentMinute = 0;
          let NextMode = 1;
          let NextHeure = 24;
          let NextMinute = 0;
          //pour boucler, récupéter la dernière entrée du jour précédent
          if( NumJour == 0){
            //lundi, prendre le dimanche
            if (Schedule[ JoursSemaine[6]].length > 0){
              CurrentMode = Schedule[ JoursSemaine[6]][(Schedule[ JoursSemaine[6]].length) - 1].mode;
            }
          }
          else{
            //autre jour, prendre le jour précédent
            if (Schedule[ JoursSemaine[NumJour - 1]].length > 0){
              CurrentMode = Schedule[ JoursSemaine[NumJour - 1]][(Schedule[ JoursSemaine[NumJour - 1]].length) - 1].mode;
            }
          }
          for (let i = 0; i < Schedule[ Jour].length; i++) {
            NextMode = Schedule[ Jour][ i].mode;
            NextHeure = Schedule[ Jour][ i].heure;
            NextMinute = Schedule[ Jour][ i].minute;
            if( CurrentMode !== NextMode){
              let x1 = 40 + (CurrentHeure * 24) + ((CurrentMinute / 5) * 2);
              let x2 = 40 + (NextHeure * 24) + ((NextMinute / 5) * 2);
              let y1 = height - 60 - (CurrentMode *50);
              let y2 = height - 60 - (NextMode * 50);
              //ligne horizontale
              ctx.moveTo(x1, y1);
              ctx.lineTo(x2, y1);
              //ligne verticale
              ctx.moveTo(x2, y1);
              ctx.lineTo(x2, y2);
              CurrentMode = NextMode;
              CurrentHeure = NextHeure;
              CurrentMinute = NextMinute;
            }
          }
          // ligne finale jusqu'à 24h
          if( CurrentHeure < 24){
            let x1 = 40 + (CurrentHeure * 24) + ((CurrentMinute / 5) * 2);
            let x2 = 40 + (24 * 24);
            let y1 = height - 60 - (CurrentMode *50);
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y1);
          }
          ctx.stroke(); 
        }

        Canvas.addEventListener("mousemove", function(event) {
          const rect = Canvas.getBoundingClientRect();
          const x = event.clientX - rect.left;
          const y = event.clientY - rect.top;

          // Effacer le canvas de position de la souris
          ctxPosMouse.clearRect(0, 0, PosMouse.width, PosMouse.height);
          ctxPosMouse.fillStyle = "black";
          ctxPosMouse.font = "16px Arial";
          if((Math.floor(x) >= 40) && 
            (Math.floor(x) <= 616) &&
            (Math.floor(y) <= (Canvas.height - 50)) && 
            (Math.floor(y) >= (Canvas.height - 235))
          )
          {
            //convertir l'abcisse en heure et minute
            let curheure = Math.floor((x - 40) / 24);
            let curminute = Math.floor(((x - 40) % 24) / 2) * 5;
            //convertir l'ordonnée en mode
            let curmode = 0;
            if((Math.floor(y) <= (Canvas.height - 85) && 
              (Math.floor(y) > (Canvas.height - 135)))){
              curmode = 1;
            }
            else if((Math.floor(y) <= (Canvas.height - 135) && 
            (Math.floor(y) > (Canvas.height - 185)))){
              curmode = 2;
            }
            else if(Math.floor(y) <= (Canvas.height - 185)){
              curmode = 3;
            }
            ctxPosMouse.fillText(`heure: ${curheure.toString().padStart(2, '0')} : ${curminute.toString().padStart(2, '0')} - mode: ${nom_state[curmode]}`, 10, 20);
          }
        });

        Canvas.addEventListener("dblclick", function(event) {
          const rect = Canvas.getBoundingClientRect();
          const x = event.clientX - rect.left;
          const y = event.clientY - rect.top;

          // Check if within valid area
           if((Math.floor(x) >= 40) && 
            (Math.floor(x) <= 616) &&
            (Math.floor(y) <= (Canvas.height - 50)) && 
            (Math.floor(y) >= (Canvas.height - 235))
          )
          {
            //convertir l'abcisse en heure et minute
            LockHeure = Math.floor((x - 40) / 24);
            LockMinute = Math.floor(((x - 40) % 24) / 2) * 5;
            //convertir l'ordonnée en mode
            LockMode = 0;
            if((Math.floor(y) <= (Canvas.height - 85) && 
              (Math.floor(y) > (Canvas.height - 135)))){
              LockMode = 1;
            }
            else if((Math.floor(y) <= (Canvas.height - 135) && 
            (Math.floor(y) > (Canvas.height - 185)))){
              LockMode = 2;
            }
            else if(Math.floor(y) <= (Canvas.height - 185)){
              LockMode = 3;
            }
            console.log(`Lock heure: ${LockHeure.toString().padStart(2, '0')} : ${LockMinute.toString().padStart(2, '0')} - mode: ${nom_state[LockMode]}`);
          }
        });

        config_req.onclick = () => {
          MainModal.style.display = "none";
          ConfigNom.textContent = MainNom.textContent;

          // Remplir les combobox jours
          JourCombo.innerHTML = "";
          JoursSemaine.forEach(opt => {
            const optionElement = document.createElement("option");
            optionElement.value = JoursSemaine.indexOf(opt);
            optionElement.textContent = opt;
            JourCombo.appendChild(optionElement);
          });
          // Définir la valeur initiale
          JourCombo.value = 0; // Par défaut Lundi
          CurJour = 0;
          //Charger le graphe
          LoadGraphModeTime( JourCombo.value );

          ConfigModal.style.display = "block";
        };

        document.getElementById("jour-Combo").addEventListener("change", function(){
          console.log(`Jour selectionné: ${JoursSemaine[this.value]}`);
          CurJour = this.value;
          LoadGraphModeTime( this.value );
        });

        function OnClickModifyRadiateur() {
          fetch(
            `/radiateur/${encodeURIComponent(itempointer.id)}/set-NewRadiateurState`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ 
                state: parseInt(ModeCombo.value),
                forceheure: parseInt(HCombo.value),
                forceminute: parseInt(MCombo.value)
              }),
            }
          )
          .then((res) => {
            if (!res.ok) throw new Error("Erreur réseau");
            return res.json().catch(() => ({}));
          })
          .then((data) => {

            if (itempointer) {
              itempointer.dataset.state = ModeCombo.value;
              itempointer.dataset.forceheure = HCombo.value;
              itempointer.dataset.forceminute = MCombo.value;  
            }
            MainState.textContent = ModeCombo.value;
            console.log(`État mis à jour : ${ModeCombo.value}`);
            ModifModal.style.display = "none";
            ChangeRadiateurColor();
          })
          .catch((err) => {
            console.error(err);
            alert("Échec de la mise à jour de l'état.");
          });          
        }

        function OnClickModifyPiece() {
          fetch(
            `/piece/${encodeURIComponent(itempointer.id)}/set-NewGroupeState`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ 
                state: parseInt(ModeCombo.value),
                forceheure: parseInt(HCombo.value),
                forceminute: parseInt(MCombo.value)
              }),
            }
        )
          .then((res) => {
            if (!res.ok) throw new Error("Erreur réseau");
            return res.json().catch(() => ({}));
          })
          .then((data) => {
            const items = document.querySelectorAll(".radiateur");
            items.forEach((item) => {
              if(item.dataset.groupe === itempointer.textContent){
                item.dataset.state = ModeCombo.value;
                item.dataset.forceheure = HCombo.value;
                item.dataset.forceminute = MCombo.value;  
              }
            });

            MainState.textContent = ModeCombo.value;
            console.log(`État mis à jour : ${ModeCombo.value}`);
            ModifModal.style.display = "none";
            ChangeRadiateurColor();
          })
          .catch((err) => {
            console.error(err);
            alert("Échec de la mise à jour de l'état.");
          });
          
        }

        Apply_modif_req.onclick = () => {
          if(((HCombo.value != 0) || (MCombo.value != 0)) &&
            (itempointer != null))
          {
            if( IsGroupe == false){
              OnClickModifyRadiateur();
            }
            else{
              OnClickModifyPiece();   
            }

          }
          else{
            ModifModal.style.display = "none";
            console.log("Pas de forcage.");
            return;
          }
        };

        apply_config_req.onclick = () => {
          fetch(
            `/radiateur/${encodeURIComponent(itempointer.id)}/set-NewRadiateurConfig`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ 
                DayConfigs: Schedule
              }),
            }
          )
          .then((res) => {
            if (!res.ok) throw new Error("Erreur réseau");
            return res.json().catch(() => ({}));
          })
          .then((data) => {
            itempointer.dataset.schedule = JSON.stringify(Schedule);
            ConfigModal.style.display = "none";
            console.log(`Configuration par jour mise à jour`);
          })
          .catch((err) => {
            console.error(err);
            alert("Échec de la mise à jour de la configuration par jour");
          });          
        };

        plus_config_req.onclick = () => {
          //value -> nom du jour
          let Jour = JoursSemaine[CurJour];
          AddPointNom.textContent = ConfigNom.textContent;
          AddPointJour.textContent = `Jour: ${Jour}`;
          // Remplir les combobox jours
          AddModeCombo.innerHTML = "";
          for (let i = 0; i <= 3; i++) {
            const Item= document.createElement("option");
            Item.value = i;
            Item.textContent = nom_state[i];
            AddModeCombo.appendChild(Item);
          }
          AddModeCombo.value = 1; // Par défaut Confort

          // Remplir les combobox heures
          AddHeureCombo.innerHTML = "";
          const ForceHeureOptions = ["00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", 
            "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23"];
          ForceHeureOptions.forEach(opt => {
            const optionElement = document.createElement("option");
            optionElement.value = ForceHeureOptions.indexOf(opt);
            optionElement.textContent = opt;
            AddHeureCombo.appendChild(optionElement);
          });
          AddHeureCombo.value = 0; // Par défaut 00

          // Remplir les combobox minutes
          AddMinuteCombo.innerHTML = "";
          const ForceMinuteOptions = ["00", "05", "10", "15", "20", "25", "30", "35", "40", "45", "50", "55"];
          ForceMinuteOptions.forEach(opt => {
            const optionElement = document.createElement("option");
            optionElement.value = ForceMinuteOptions.indexOf(opt) * 5;
            optionElement.textContent = opt;
            AddMinuteCombo.appendChild(optionElement);
          });
          AddMinuteCombo.value = 0; // Par défaut 00

          AddPointModal.style.display = "block";
        };

        document.getElementById("closeModal_AddPoint").onclick = () => {
          AddPointModal.style.display = "none";
        };
        AddPoint_config_req.onclick = () => {
          //value -> nom du jour
          let Jour = JoursSemaine[CurJour];
          const newHeure = parseInt(AddHeureCombo.value);
          const newMinute = parseInt(AddMinuteCombo.value);
          const newMode = parseInt(AddModeCombo.value);
          //vérifier si le point existe déjà
          const exists = Schedule[ Jour].some(point => point.heure === newHeure && point.minute === newMinute);
          if( exists ){
            alert("Un point existe déjà à cette heure.");
            return;
          }
          //ajouter le point
          Schedule[ Jour].push({ heure: newHeure, minute: newMinute, mode: newMode });
          alert(`Point ajouté: ${newHeure.toString().padStart(2, '0')}H${newMinute.toString().padStart(2, '0')} - ${nom_state[newMode]}`);
          AddPointModal.style.display = "none";
          LoadGraphModeTime( CurJour );
        };

        minus_config_req.onclick = () => {
          //value -> nom du jour
          let Jour = JoursSemaine[CurJour];
          DelPointNom.textContent = ConfigNom.textContent;
          DelPointJour.textContent = `Jour: ${Jour}`;
          // Remplir les combobox jours
          DelPointCombo.innerHTML = "";
          for (let i = 0; i < Schedule[ Jour].length; i++) {
            const Item= document.createElement("option");
            Item.value = i;
            Item.textContent = 
              `${Schedule[Jour][i].heure.toString().padStart(2, '0')}H${Schedule[ Jour][i].minute.toString().padStart(2, '0')} - ${nom_state[Schedule[ Jour][i].mode]}`;
            DelPointCombo.appendChild(Item);
          }
          DelPointCombo.value = 0; // Par défaut le premier
          DelPointModal.style.display = "block";
        };

        document.getElementById("closeModal_DelPoint").onclick = () => {
          DelPointModal.style.display = "none";
        };

        DelPoint_config_req.onclick = () => {
          //value -> nom du jour
          let Jour = JoursSemaine[CurJour];
          const indexToDelete = parseInt(DelPointCombo.value);
          if( isNaN(indexToDelete) || indexToDelete < 0 || indexToDelete >= Schedule[ Jour].length){
            alert("Index invalide.");
            return;
          }
          Schedule[ Jour].splice(indexToDelete, 1);
          alert(`Point ${indexToDelete} supprimé.`);
          DelPointModal.style.display = "none";
          LoadGraphModeTime( CurJour );
        };

        ChangeRadiateurColor();
      </script>
    </header>
  </body>
</html>
